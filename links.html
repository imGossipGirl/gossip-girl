<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gossip Girl — Spotted Map</title>

<link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/thumb/6/64/Gossip_girl_titlecard.svg/1200px-Gossip_girl_titlecard.svg.png">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

<style>
body, html {
  margin: 0;
  padding: 0;
  font-family: 'Roboto', sans-serif;
  background: url('https://primary.jwwb.nl/public/v/f/z/temp-drvbpvglefwdvbrbqnho/ur18xk/IMG_1169.jpg')
    no-repeat center center fixed;
  background-size: cover;
}

.container {
  max-width: 900px;
  margin: 30px auto;
  padding: 20px;
}

.card {
  background: rgba(255,255,255,0.96);
  border-radius: 14px;
  padding: 20px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.4);
  margin-bottom: 20px;
}

h3 {
  font-family: 'Playfair Display', serif;
}

#map {
  height: 450px;
  border-radius: 12px;
}

input, textarea {
  width: 100%;
  padding: 8px;
  margin-bottom: 8px;
}

button {
  width: 100%;
  padding: 8px;
  background: #111;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

button.secondary {
  background: transparent;
  color: #555;
  border: 1px solid #ccc;
  margin-top: 6px;
}

.delete-btn {
  background: #7a2c2c;
  margin-top: 6px;
}
</style>
</head>

<body>

<div class="container">

  <div class="card" style="text-align:center;">
    <button class="secondary" onclick="window.location.href='index.html'">
      ← Back to Home
    </button>
  </div>

  <div class="card">
    <h3>Spotted Map</h3>
    <div id="map"></div>
  </div>

  <!-- LOGIN -->
  <div id="loginBox" class="card" style="display:none;">
    <h3>Gossip Girl Login</h3>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
  </div>

  <!-- ADMIN FORM -->
  <div id="adminForm" class="card" style="display:none;">
    <h3>Add Sighting</h3>
    <input id="spotName" placeholder="Who was spotted?">
    <textarea id="spotNote" placeholder="Details"></textarea>
    <input id="spotImage" placeholder="Image URL (https://...)">
    <button onclick="saveSpot()">Save Sighting</button>
    <button class="secondary" onclick="logout()">Logout</button>
  </div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ===== FIREBASE INIT ===== */
firebase.initializeApp({
  apiKey: "AIzaSyAG70-TmzFjnvgZhRkPR1DuDOrTComfwsc",
  authDomain: "gossip-girl-4e394.firebaseapp.com",
  projectId: "gossip-girl-4e394"
});

const auth = firebase.auth();
const db = firebase.firestore();

/* ===== MAP ===== */
const map = L.map("map").setView([40.7831, -73.9712], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap"
}).addTo(map);

let selectedLatLng = null;
let markers = [];

/* ===== AUTH UI ===== */
auth.onAuthStateChanged(user => {
  loginBox.style.display = user ? "none" : "block";
  adminForm.style.display = user ? "block" : "none";
});

/* ===== LOGIN ===== */
function login() {
  auth.signInWithEmailAndPassword(email.value, password.value)
    .catch(err => alert(err.message));
}

function logout() {
  auth.signOut();
}

/* ===== CLICK TO SELECT LOCATION ===== */
map.on("click", e => {
  if (!auth.currentUser) return;
  selectedLatLng = e.latlng;
  alert("Location selected. Now save the sighting.");
});

/* ===== SAVE SPOT ===== */
function saveSpot() {
  if (!selectedLatLng) {
    alert("Click a location on the map first.");
    return;
  }

  if (!spotName.value) {
    alert("Enter a name.");
    return;
  }

  db.collection("spots").add({
    name: spotName.value,
    note: spotNote.value,
    image: spotImage.value,
    lat: selectedLatLng.lat,
    lng: selectedLatLng.lng,
    time: Date.now(),
    by: auth.currentUser.email
  });

  spotName.value = "";
  spotNote.value = "";
  spotImage.value = "";
  selectedLatLng = null;
}

/* ===== LOAD SPOTS (PUBLIC) ===== */
db.collection("spots").orderBy("time", "desc")
.onSnapshot(snapshot => {
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  snapshot.forEach(doc => {
    const s = doc.data();
    const marker = L.marker([s.lat, s.lng]).addTo(map);

    marker.bindPopup(`
      <strong>${s.name}</strong><br>
      ${s.note || ""}<br>
      ${s.image ? `<img src="${s.image}" style="width:150px;margin-top:6px;">` : ""}
      ${auth.currentUser ? `<br><button class="delete-btn" onclick="deleteSpot('${doc.id}')">Delete</button>` : ""}
    `);

    markers.push(marker);
  });
});

/* ===== DELETE ===== */
function deleteSpot(id) {
  if (confirm("Delete this sighting?")) {
    db.collection("spots").doc(id).delete();
  }
}
</script>

</body>
</html>

